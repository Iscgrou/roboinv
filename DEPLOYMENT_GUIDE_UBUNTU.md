# راهنمای کامل راه‌اندازی ربات در سرور اوبونتو 22 (برای افراد غیرفنی)

این راهنما به صورت قدم به قدم تمام مراحل لازم برای راه‌اندازی کامل ربات دستیار حسابداری روی یک سرور خام با سیستم‌عامل Ubuntu 22 را توضیح می‌دهد. فرض بر این است که شما به ترمینال سرور خود دسترسی دارید.

---

### فاز ۱: آماده‌سازی سرور و نصب پیش‌نیازها

در این مرحله، سرور خود را آماده و ابزارهای لازم را نصب می‌کنیم.

#### قدم ۱.۱: اتصال به سرور
ابتدا از طریق SSH به سرور خود متصل شوید. آدرس IP سرور خود را جایگزین `YOUR_SERVER_IP` کنید.
```bash
ssh root@YOUR_SERVER_IP
```

#### قدم ۱.۲: آپدیت سرور
همیشه بهتر است قبل از نصب هر چیزی، لیست پکیج‌های سرور را آپدیت کنید.
```bash
sudo apt update && sudo apt upgrade -y
```

#### قدم ۱.۳: نصب ابزارهای کلیدی (Git, Docker)
ما به سه ابزار اصلی نیاز داریم: `git` برای دریافت کدها، `docker` برای اجرای اپلیکیشن‌ها در کانتینر، و `docker-compose` برای هماهنگ کردن این کانتینرها.

```bash
# نصب Git
sudo apt install git -y

# نصب Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# نصب Docker Compose V2 (که اکنون یک پلاگین است)
sudo apt-get install docker-compose-plugin -y
```
پس از این مرحله، سرور شما تمام ابزارهای لازم برای اجرای پروژه را دارد.

---

### فاز ۲: دریافت و تنظیم کدهای پروژه

حالا کدهای پروژه را از ریپازیتوری گیت‌هاب دریافت کرده و تنظیمات اولیه آن را انجام می‌دهیم.

#### قدم ۲.۱: دریافت پروژه از گیت‌هاب
دستور زیر، آخرین نسخه پروژه را از ریپازیتوری در سرور شما کپی می‌کند.
```bash
git clone https://github.com/Iscgrou/roboinv.git
```

#### قدم ۲.۲: ورود به پوشه پروژه
```bash
cd roboinv
```

#### قدم ۲.۳: ساخت و ویرایش فایل تنظیمات
یک کپی از فایل نمونه تنظیمات می‌سازیم و سپس آن را ویرایش می‌کنیم.
```bash
# کپی کردن فایل نمونه
cp .env.example .env

# باز کردن فایل برای ویرایش با ویرایشگر nano
nano .env
```
پس از اجرای دستور بالا، یک ویرایشگر متن باز می‌شود. مقادیر زیر را با اطلاعات واقعی خود جایگزین کنید:
- `TELEGRAM_BOT_TOKEN`: توکن ربات تلگرام خود را که از BotFather گرفته‌اید، اینجا قرار دهید.
- `JWT_SECRET`: یک رشته بسیار طولانی و تصادفی برای امنیت وارد کنید (مثال: `my-super-secret-key-123!@#$`).
- `ADMIN_CHAT_ID`: آیدی عددی اکانت تلگرام خودتان را وارد کنید (می‌توانید از ربات `@userinfobot` برای پیدا کردن آن استفاده کنید).

پس از ویرایش، برای ذخیره کردن فایل:
1.  دکمه `Ctrl + X` را فشار دهید.
2.  سپس دکمه `Y` را فشار دهید.
3.  در نهایت دکمه `Enter` را فشار دهید.

---

### فاز ۳: اجرای زیرساخت و آماده‌سازی پایگاه داده

در این مرحله، پایگاه داده را اجرا کرده، جداول را در آن می‌سازیم و اولین کاربر ادمین را تعریف می‌کنیم.

#### قدم ۳.۱: اجرای پایگاه داده
دستور زیر کانتینرهای پایگاه داده PostgreSQL و صف پیام RabbitMQ را در پس‌زمینه اجرا می‌کند.
```bash
sudo docker compose up -d postgres rabbitmq
```

#### قدم ۳.۲: ساخت جداول
برای این مرحله نیاز به یک ابزار مدیریت پایگاه داده روی کامپیوتر شخصی خود دارید (مانند **DBeaver** یا **TablePlus** که رایگان هستند).
- با استفاده از این ابزارها، به پایگاه داده روی سرور خود متصل شوید. اطلاعات اتصال:
    - **Host:** آدرس IP سرور شما (YOUR_SERVER_IP)
    - **Port:** 5432
    - **Database:** financial_bot
    - **User:** user
    - **Password:** password
- پس از اتصال، تمام فایل‌های با پسوند `.sql` که در پوشه‌ی `database/sql` پروژه قرار دارند را به ترتیب باز کرده و محتوای آن‌ها را در ابزار خود اجرا (Run) کنید.

#### قدم ۳.۳: ساخت اولین کاربر ادمین
این مرحله برای این است که شما بتوانید در ربات لاگین کنید.
1.  **ساخت هش پسورد:**
    -   در ترمینال سرور، ابتدا سرویس احراز هویت را به تنهایی اجرا کنید:
        ```bash
        sudo docker compose up auth-service
        ```
    -   یک ترمینال SSH جدید به سرور خود باز کنید و دستور زیر را اجرا کنید. **"YOUR_STRONG_PASSWORD"** را با پسورد دلخواه خود جایگزین کنید:
        ```bash
        curl -X POST -H "Content-Type: application/json" -d '{"password": "YOUR_STRONG_PASSWORD"}' http://localhost:3010/hash-password
        ```
    -   یک **هش** طولانی مانند `$2b$10$...` در پاسخ دریافت خواهید کرد. این هش را به طور کامل کپی کنید.
    -   به ترمینال اول برگردید و با زدن `Ctrl + C` سرویس را متوقف کنید.

2.  **درج کاربر در دیتابیس:**
    -   به ابزار مدیریت پایگاه داده خود برگردید و دستور SQL زیر را اجرا کنید. مقادیر `YOUR_ADMIN_CHAT_ID`, `'your_username'`, و `'THE_HASH_YOU_COPIED'` را با اطلاعات واقعی خود جایگزین کنید.
        ```sql
        INSERT INTO admin_users (id, telegram_id, name, role, password_hash, created_at, updated_at) 
        VALUES (gen_random_uuid(), 'YOUR_ADMIN_CHAT_ID', 'your_username', 'admin', 'THE_HASH_YOU_COPIED', NOW(), NOW());
        ```

---

### فاز ۴: اجرای نهایی ربات

اکنون همه چیز آماده است تا تمام سرویس‌های ربات را اجرا کنیم.

#### قدم ۴.۱: اجرای کامل پروژه
در ترمینال سرور و در پوشه‌ی `roboinv`، دستور زیر را اجرا کنید:
```bash
sudo docker compose up --build -d
```
این دستور تمام سرویس‌های پروژه را ساخته و در پس‌زمینه اجرا می‌کند. ممکن است بار اول چند دقیقه طول بکشد.

#### قدم ۴.۲: بررسی وضعیت
برای اطمینان از اینکه همه چیز به درستی اجرا شده، دستور زیر را وارد کنید:
```bash
sudo docker compose ps
```
شما باید لیستی از تمام سرویس‌ها را ببینید که در ستون `State` همگی `Up` هستند.

#### قدم ۴.۳: شروع کار
ربات شما اکنون فعال است! به تلگرام بروید و با ارسال دستور `/login` و سپس پسوردی که تعریف کردید، کار با ربات را آغاز کنید.

موفق باشید!
